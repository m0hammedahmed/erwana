<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>لوحة تحكم التسوية - Reconciliation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet" />
    <style>
      :root { --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-sidebar: #1e293b; --text-primary: #0f172a; --text-secondary: #64748b; --text-sidebar: #f1f5f9; --border-color: #e2e8f0; --accent-blue: #3b82f6; --accent-green: #10b981; --accent-red: #ef4444; --accent-yellow: #f59e0b; }
      .dark-mode { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-sidebar: #020617; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-sidebar: #f1f5f9; --border-color: #334155; }
      * { font-family: "Tajawal", sans-serif; }
      body { background-color: var(--bg-secondary); color: var(--text-primary); transition: all 0.3s ease; }
      .sidebar { background: linear-gradient(180deg, var(--bg-sidebar) 0%, #0f172a 100%); color: var(--text-sidebar); }
      .nav-item.active { background: rgba(59, 130, 246, 0.15); font-weight: 600; }
      .nav-item:hover { background: rgba(59, 130, 246, 0.1); }
      .stat-card { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: 0.3s; }
      .data-table th { background: var(--bg-sidebar); color: var(--text-sidebar); position: sticky; top: 0; padding: 1rem; text-align: right; }
      .data-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); }
      .data-table { background: var(--bg-primary); border-radius: 12px; overflow: hidden; }
      .row-matched { background: rgba(59, 130, 246, 0.08); }
      .row-higher { background: rgba(16, 185, 129, 0.08); }
      .row-lower { background: rgba(239, 68, 68, 0.08); }
      .row-not-found { background: rgba(245, 158, 11, 0.08); }
      .dark-mode .row-matched { background: rgba(59, 130, 246, 0.15); }
      .dark-mode .row-higher { background: rgba(16, 185, 129, 0.15); }
      .dark-mode .row-lower { background: rgba(239, 68, 68, 0.15); }
      .dark-mode .row-not-found { background: rgba(245, 158, 11, 0.15); }
      .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.875rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; }
      .badge-matched { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
      .badge-higher { background: rgba(16, 185, 129, 0.15); color: #10b981; }
      .badge-lower { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
      .badge-not-found { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
      .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 50; }
      .modal.active { display: flex; }
      .modal-content { background: var(--bg-primary); padding: 2rem; border-radius: 16px; width: 90%; max-width: 500px; }
      .input-field { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); }
      .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; gap: 0.5rem; align-items: center; }
      .btn-primary { background: var(--accent-blue); color: white; }
      .btn-secondary { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); }
      .spinner { border: 3px solid var(--border-color); border-top: 3px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .fade-in { animation: fadeIn 0.3s ease; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  </head>
  <body>
    <div class="sidebar fixed top-0 right-0 h-screen w-64 flex flex-col z-20">
      <div class="p-6 border-b border-gray-700">
        <div class="flex items-center gap-3">
          <div class="bg-blue-500 w-12 h-12 rounded-lg flex items-center justify-center"><i class="fas fa-chart-line text-white text-xl"></i></div>
          <div><h1 class="text-lg font-bold">لوحة التسوية</h1><p class="text-xs text-gray-400">Reconciliation</p></div>
        </div>
      </div>
      <div class="flex-1 overflow-y-auto p-4">
        <h3 class="text-xs font-semibold text-gray-400 mb-3 px-3">التصفية حسب الحالة</h3>
        <div class="space-y-1">
          <div class="nav-item active rounded-lg p-3 flex justify-between" data-filter="all"><div class="flex gap-3"><i class="fas fa-list text-blue-400"></i><span>الكل</span></div><span id="count-all" class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full text-xs">0</span></div>
          <div class="nav-item rounded-lg p-3 flex justify-between" data-filter="matched"><div class="flex gap-3"><i class="fas fa-check text-blue-400"></i><span>متطابق</span></div><span id="count-matched" class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full text-xs">0</span></div>
          <div class="nav-item rounded-lg p-3 flex justify-between" data-filter="higher"><div class="flex gap-3"><i class="fas fa-arrow-trend-up text-green-400"></i><span>أعلى</span></div><span id="count-higher" class="bg-green-500/20 text-green-400 px-2 py-1 rounded-full text-xs">0</span></div>
          <div class="nav-item rounded-lg p-3 flex justify-between" data-filter="lower"><div class="flex gap-3"><i class="fas fa-arrow-trend-down text-red-400"></i><span>أقل</span></div><span id="count-lower" class="bg-red-500/20 text-red-400 px-2 py-1 rounded-full text-xs">0</span></div>
          <div class="nav-item rounded-lg p-3 flex justify-between" data-filter="not-found"><div class="flex gap-3"><i class="fas fa-triangle-exclamation text-yellow-400"></i><span>غير موجود</span></div><span id="count-not-found" class="bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full text-xs">0</span></div>
        </div>
      </div>
      <div class="p-4 border-t border-gray-700 space-y-3">
        <div class="flex justify-between p-3 hover:bg-gray-800/50 rounded-lg cursor-pointer" id="dark-mode-toggle"><div class="flex gap-3"><i class="fas fa-moon text-gray-400"></i><span>الوضع الليلي</span></div><div class="toggle-switch" id="theme-toggle"></div></div>
        <button class="w-full p-3 hover:bg-gray-800/50 rounded-lg cursor-pointer flex gap-3" id="settings-btn"><i class="fas fa-cog text-gray-400"></i><span>الإعدادات</span></button>
      </div>
    </div>
    <div class="mr-64 min-h-screen p-8">
      <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
          <div><h2 class="text-3xl font-bold mb-2">مرحباً بك</h2><p class="text-gray-500">قم برفع ملف Bosta للمطابقة</p></div>
          <div class="flex gap-3">
            <button class="btn btn-secondary" id="export-btn" style="display: none"><i class="fas fa-download"></i> تصدير</button>
            <label for="file-upload" class="btn btn-primary"><i class="fas fa-upload"></i> رفع ملف</label>
            <input type="file" id="file-upload" accept=".xlsx,.xls,.csv" style="display: none" />
          </div>
        </div>
        <div class="relative"><i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="text" id="search-input" class="input-field pr-12" placeholder="بحث..." /></div>
      </div>
      <div class="grid grid-cols-4 gap-6 mb-8" id="stats-container">
        <div class="stat-card text-blue-500"><div class="flex justify-between mb-3"><i class="fas fa-check text-3xl"></i><span>متطابق</span></div><div class="text-3xl font-bold" id="stat-matched">0</div></div>
        <div class="stat-card text-green-500"><div class="flex justify-between mb-3"><i class="fas fa-arrow-trend-up text-3xl"></i><span>أعلى</span></div><div class="text-3xl font-bold" id="stat-higher">0</div></div>
        <div class="stat-card text-red-500"><div class="flex justify-between mb-3"><i class="fas fa-arrow-trend-down text-3xl"></i><span>أقل</span></div><div class="text-3xl font-bold" id="stat-lower">0</div></div>
        <div class="stat-card text-yellow-500"><div class="flex justify-between mb-3"><i class="fas fa-triangle-exclamation text-3xl"></i><span>غير موجود</span></div><div class="text-3xl font-bold" id="stat-not-found">0</div></div>
      </div>
      <div class="data-table" id="table-container">
        <div class="empty-state"><i class="fas fa-file-excel text-6xl mb-4 opacity-30"></i><h3>لا توجد بيانات</h3></div>
      </div>
      <div id="loading-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); padding: 2rem; border-radius: 12px; text-align: center;"><div class="spinner mx-auto mb-4"></div><p>جاري المعالجة...</p></div>
      </div>
    </div>
    <div class="modal" id="settings-modal">
      <div class="modal-content">
        <div class="flex justify-between mb-6"><h3>الإعدادات</h3><button id="close-modal" class="text-2xl">&times;</button></div>
        <div class="space-y-4">
          <div><label>رابط Webhook</label><input type="url" id="webhook-url" class="input-field" placeholder="https://..." /></div>
          <button class="btn btn-primary w-full" id="save-settings">حفظ</button>
        </div>
      </div>
    </div>

    <script>
      let allData = [], filteredData = [], currentFilter = "all";
      let webhookUrl = localStorage.getItem("webhookUrl") || "";

      document.addEventListener("DOMContentLoaded", () => {
        if(localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");
        if(webhookUrl) document.getElementById("webhook-url").value = webhookUrl;
        
        document.getElementById("dark-mode-toggle").onclick = () => {
          document.body.classList.toggle("dark-mode");
          localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
        };
        
        document.getElementById("settings-btn").onclick = () => document.getElementById("settings-modal").classList.add("active");
        document.getElementById("close-modal").onclick = () => document.getElementById("settings-modal").classList.remove("active");
        
        document.getElementById("save-settings").onclick = () => {
          const url = document.getElementById("webhook-url").value.trim();
          if(!url) return alert("أدخل الرابط");
          localStorage.setItem("webhookUrl", url);
          webhookUrl = url;
          document.getElementById("settings-modal").classList.remove("active");
          alert("تم الحفظ");
        };

        document.getElementById("file-upload").onchange = async (e) => {
          const file = e.target.files[0];
          if(!file) return;
          if(!webhookUrl) return alert("اضبط الإعدادات أولاً");
          
          document.getElementById("loading-overlay").style.display = "flex";
          
          try {
            const data = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = e => resolve(XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type:'array'}).Sheets[XLSX.read(e.target.result, {type:'array'}).SheetNames[0]]));
              reader.onerror = () => reject("فشل القراءة");
              reader.readAsArrayBuffer(file);
            });

            const response = await fetch(webhookUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ data: data })
            });

            if(!response.ok) throw new Error("خطأ في الاتصال: " + response.statusText);
            const result = await response.json();
            
            // Data Mapping
            allData = (Array.isArray(result) ? result : result.data || []).map(item => ({
              orderId: item.orderId || item.OrderID || "",
              sheetValue: parseFloat(item.sheetValue || 0),
              bostaValue: parseFloat(item.bostaValue || item.netValue || 0),
              diff: parseFloat(item.diff || 0),
              status: item.category || "not-found"
            }));

            filteredData = allData;
            renderTable();
            document.getElementById("loading-overlay").style.display = "none";
            e.target.value = "";

          } catch (err) {
            document.getElementById("loading-overlay").style.display = "none";
            alert("⚠️ حدث خطأ!\n" + err.message + "\n\nلو الرسالة (Failed to fetch)، تأكد إنك مشغل إضافة CORS في المتصفح.");
            console.error(err);
          }
        };

        // ... Rest of UI logic (Search, Filter, Export) ...
        document.getElementById("search-input").oninput = (e) => {
            const term = e.target.value.toLowerCase();
            filteredData = allData.filter(row => row.orderId.toLowerCase().includes(term));
            renderTable();
        };

        document.querySelectorAll(".nav-item").forEach(el => {
            el.onclick = () => {
                document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
                el.classList.add("active");
                const filter = el.dataset.filter;
                filteredData = filter === "all" ? allData : allData.filter(d => d.status === filter);
                renderTable();
            }
        });
      });

      function renderTable() {
        const stats = { matched:0, higher:0, lower:0, notFound:0 };
        allData.forEach(d => { if(d.status === "matched") stats.matched++; else if(d.status === "higher") stats.higher++; else if(d.status === "lower") stats.lower++; else stats.notFound++; });
        
        document.getElementById("stat-matched").innerText = stats.matched;
        document.getElementById("stat-higher").innerText = stats.higher;
        document.getElementById("stat-lower").innerText = stats.lower;
        document.getElementById("stat-not-found").innerText = stats.notFound;
        document.getElementById("count-all").innerText = allData.length;
        document.getElementById("count-matched").innerText = stats.matched;
        document.getElementById("count-higher").innerText = stats.higher;
        document.getElementById("count-lower").innerText = stats.lower;
        document.getElementById("count-not-found").innerText = stats.notFound;

        const tbody = filteredData.map(row => `
          <tr class="row-${row.status}">
            <td class="font-bold">${row.orderId}</td>
            <td>${row.sheetValue.toFixed(2)}</td>
            <td>${row.bostaValue.toFixed(2)}</td>
            <td class="font-bold" style="color:${row.diff > 0 ? 'green' : row.diff < 0 ? 'red' : 'gray'}">${row.diff.toFixed(2)}</td>
            <td>${getStatusBadge(row.status)}</td>
          </tr>`).join("");

        document.getElementById("table-container").innerHTML = filteredData.length ? 
          `<table class="w-full"><thead><tr><th>رقم الطلب</th><th>قيمة الشيت</th><th>قيمة الملف</th><th>الفرق</th><th>الحالة</th></tr></thead><tbody>${tbody}</tbody></table>` : 
          `<div class="empty-state"><h3>لا توجد نتائج</h3></div>`;
      }

      function getStatusBadge(s) {
        if(s==='matched') return '<span class="badge-matched"><i class="fas fa-check"></i> متطابق</span>';
        if(s==='higher') return '<span class="badge-higher"><i class="fas fa-arrow-up"></i> أعلى</span>';
        if(s==='lower') return '<span class="badge-lower"><i class="fas fa-arrow-down"></i> أقل</span>';
        return '<span class="badge-not-found"><i class="fas fa-exclamation"></i> غير موجود</span>';
      }
    </script>
  </body>
</html>
